---
title: "Xcertainty Growth Curves"
output: rmarkdown::html_vignette
description: >
  Here we provide an example of the Xcertainty growth_curve_sampler(). You'll learn how to use data containing individuals with replicate samples consisting of drone-based measurments and age information to fit a Von Bertalanffy-Putter growth curve in a Bayesian framework.
vignette: >
  %\VignetteIndexEntry{Introduction to Xcertainty}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
fontsize: 13pt 
author: "KC Bierlich & Josh Hewitt, CODEX"
date: "2024-08-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Before moving forward, be sure to first check out the [Xcertainty](Xcertainty.html) vignette on how to use the `independent_length_sampler()` for a proper introduction on how to use `Xcertainty`. This vignette focuses on the `growth_curve_sampler()`, which uses data containing individuals with replicate body length measurements and age information over time. This model fits a Von Bertalanffy-Putter growth curve to observations and incorporates measurement uncertainty associated with multiple drones following [Pirotta and Bierlich et al., 2024](https://doi.org/10.1111/gcb.17366). 


Von Bertalanffy-Putter growth curve equations involve three parameters: growth rate (*k*), asymptotic length (*A*), and the (theoretical) age when size is equal to 0 (*t0*).   

In this vignette, we'll use the `growth_curve_sampler()` to reproduce results derived from the data and methods described by [Pirotta and Bierlich et al., 2024](https://doi.org/10.1111/gcb.17366).  

We'll first load the Xcertainty package, as well as other packages we will use throughout this example.
```{r, echo=TRUE, warning=FALSE}
library(Xcertainty)

library(tidyverse)
library(ggdist)
```



### Data
We will use calibration and observation (whale) length and age data from [Pirotta and Bierlich et al., 2024](https://doi.org/10.1111/gcb.17366). This data includes imagery collected by five different UAS. Whale age's are estimated using photo-identification history and are labeled as either a 'known age' (if seen as a calf) or a 'minimum age' (based on the date of the first sighting). 

&nbsp;

#### Calibration data
We'll use a calibration dataset consisting of measurements of a 1 m wooden board collected by five different UAS at various altitudes (13-62 m). 
```{r}
data('calibration')

# sample size for each UAS
table(calibration$uas)

```


### parse_observations()
We'll use `parse_observations()` to prepare the calibration and whale data. 
Measurements are often recorded in a wide-format dataframe, so parse_observations() converts to long-format data.  
```{r}
# parse calibration study
calibration_data = parse_observations(
  x = calibration, 
  subject_col = 'CO.ID',
  meas_col = 'Lpix', 
  tlen_col = 'CO.L', 
  image_col = 'image', 
  barometer_col = 'Baro_Alt',
  laser_col = 'Laser_Alt', 
  flen_col = 'Focal_Length', 
  iwidth_col = 'Iw', 
  swidth_col = 'Sw',
  uas_col = 'uas'
)
```

* This creates a list of three dataframes:   
    + `calibration_data$pixel_counts`.   
    + `calibration_data$training_objects`.    
    + `calibration_data$image_info`.  


Next, we'll use `parse_observations()` to prepare the whale data. Note, that the `timepoint_col` is set to year since we are interested in the total body length of each individual summarized at the yearly scale. 
```{r}
data('whales')

# parse field study
whale_data = parse_observations(
  x = whales, 
  subject_col = 'whale_ID',
  meas_col = 'TL.pix', 
  image_col = 'Image', 
  barometer_col = 'AltitudeBarometer',
  laser_col = 'AltitudeLaser', 
  flen_col = 'FocalLength', 
  iwidth_col = 'ImageWidth', 
  swidth_col = 'SensorWidth', 
  uas_col = 'UAS',
  timepoint_col = 'year'
)
```


&nbsp;

Now the calibration and whale data are both ready. Time to set up the sampler. 

&nbsp;

## The sampler
Note that `combine_observations()` is used to combine the `parse_calibrations()` outputs, `calibration_data` and `whale_data`. We will use non-informative priors here. 
```{r, warning=FALSE}
sampler = growth_curve_sampler(
  data = combine_observations(calibration_data, whale_data),
  priors = list(
    image_altitude = c(min = 0.1, max = 130),
    altimeter_bias = rbind(
      data.frame(altimeter = 'Barometer', mean = 0, sd = 1e2),
      data.frame(altimeter = 'Laser', mean = 0, sd = 1e2)
    ),
    altimeter_variance = rbind(
      data.frame(altimeter = 'Barometer', shape = .01, rate = .01),
      data.frame(altimeter = 'Laser', shape = .01, rate = .01)
    ),
    altimeter_scaling = rbind(
      data.frame(altimeter = 'Barometer', mean = 0, sd = 1e1),
      data.frame(altimeter = 'Laser', mean = 0, sd = 1e1)
    ),
    pixel_variance = c(shape = .01, rate = .01),
    # priors from Agbayani et al. 
    zero_length_age = c(mean = -5.09, sd = 0.4),
    growth_rate = c(mean = .18, sd = .01),
    # additional priors
    group_asymptotic_size = rbind(
      Female = c(mean = 12, sd = .5),
      Male = c(mean = 12, sd = .5)
    ),
    group_asymptotic_size_trend = rbind(
      Female = c(mean = 0, sd = 1),
      Male = c(mean = 0, sd = 1)
    ),
    subject_group_distribution = c(Female = .5, Male = .5),
    asymptotic_size_sd = c(min = 0, max = 10),
    min_calf_length = 3.5,
    # To model break points between 1990 and 2015
    group_size_shift_start_year = c(min = 1990, max = 2015)
  ),
  subject_info = whale_info
)
```


$nbsp;


Now run the sampler!
```{r}
output_growth = sampler(niter = 1e4)
```


## View Sampler Outputs 
Our saved `output_growth` contains all the posterior samples and summaries from the sampler. Note, that there are many objects stored in `output_growth`, so it is best to view specific selections rather than viewing all of the objects stored in `output_growth` at once, as this can take a very long time to load and cause R to freeze. 

&nbsp;

You can view the posterior summaries (mean, sd, etc.) of total body length (TL) for each individual (Subject) at each Timepoint (year). Note that the `lower` and `upper` represent the 95% highest posterior density intervals (HPDI) of the posterior distribution for TL.
```{r}
head(output_growth$summaries$objects)
```


&nbsp;

We can view the posterior summaries (mean, sd, and lower and upper 95% HPDI) of the posterior distribution.
```{r}
output_growth$summaries$altimeters
```

We can view the posterior summaries of the pixel variance
```{r}
output_growth$pixel_error$summary
```

&nbsp;

Let's view a preview of the posterior summaries of the growth curve parameters, including k, t0, A for males and females, and individual's birth year.
```{r}
output_growth$summaries$growth_curve[1:10,]
```

&nbsp;

Let's now create a data frame with the posterior summaries for each individual's length. We will first save the total length output summaries, then save the birth year outputs, then combine both of these dataframes by `Subject`, and then join with `whale_info` to sync sex and AgeType Finally, we'll calculate the estimated age from the sample year and the estimated birth year. 
```{r}
# total length summary outputs for each subject
sums_L <- output_growth$summaries$objects

# birth year summary outputs for each subject
birth_year <- output_growth$growth_curve$birth_year$summary %>% rename_with(~str_c("birth_year_", .), everything()) %>%
  separate(birth_year_parameter, c("Subject", "parameter"), sep = " ") %>% select(!parameter)

# combine total length and birth year summary outputs. Then join with whale info to get sex, AgeType. Finally, calculated new estimated age. 
sum <- sums_L %>% 
  left_join(birth_year, by = "Subject") %>% mutate(Year = as.integer(Timepoint)) %>%
  left_join(whale_info %>% mutate(Subject = as.factor(Subject)) %>% rename(sex = Group), by = c("Subject", "Year")) %>% 
  relocate(Year, .before = Timepoint) %>% mutate(Age_est = Year - birth_year_mean)
```

&nbsp;

We can view these results
```{r}
ggplot() + theme_bw() + 
  geom_pointrange(data = sum, aes(x = Age_est, y = mean, ymin = lower, ymax = upper)) +
  xlab("estimated age") + ylab("total body length (m)") 

```

&nbsp; 

Now we'll save the posterior summaries of the growth parameters and then create a dataframe and calculate the expected length for male and females separately using the Von Bertalanffy-Putter growth equation.

```{r}
growth_params <- output_growth$summaries$growth_curve[1:6, ]
growth_params

## Females
growth_F <- data.frame(Age_est = as.integer(seq(from  = 1, to = 40, by = 1)),
           sex = "Female", 
            t0.mean = growth_params[1,2],
           t0.lower = growth_params[1,4],
           t0.upper = growth_params[1,5],
           K.mean = growth_params[2,2],
           K.lower = growth_params[2,4],
           K.upper = growth_params[2,5],
            L.asym.F.mean = growth_params[3,2],
           L.asym.F.lower = growth_params[3,4],
           L.asym.F.upper = growth_params[3,5]) %>%
  mutate(Exp.L.mean = L.asym.F.mean * (1-exp(-K.mean * (Age_est - t0.mean))),
         Exp.L.lower = L.asym.F.lower * (1-exp(-K.lower * (Age_est - t0.lower))),
         Exp.L.upper = L.asym.F.upper * (1-exp(-K.upper * (Age_est - t0.upper))))

## Males
growth_M <- data.frame(Age_est = as.integer(seq(from  = 1, to = 40, by = 1)),
           sex = "Male", 
            t0.mean = growth_params[1,2],
           t0.lower = growth_params[1,4],
           t0.upper = growth_params[1,5],
           K.mean = growth_params[2,2],
           K.lower = growth_params[2,4],
           K.upper = growth_params[2,5],
            L.asym.M.mean = growth_params[4,2],
           L.asym.M.lower = growth_params[4,4],
           L.asym.M.upper = growth_params[4,5]) %>%
  mutate(Exp.L.mean = L.asym.M.mean * (1-exp(-K.mean * (Age_est - t0.mean))),
         Exp.L.lower = L.asym.M.lower * (1-exp(-K.lower * (Age_est - t0.lower))),
         Exp.L.upper = L.asym.M.upper * (1-exp(-K.upper * (Age_est - t0.upper))))
```


$nbsp; 

Now we can plot the results
```{r}
sum %>% filter(!is.na(sex)) %>%
  ggplot() + theme_bw() + 
  geom_pointrange(aes(x = Age_est, y = mean, ymin = lower, ymax = upper, color = sex)) +
  scale_color_manual(values = c(Female = "lightblue3", Male = "darkorange")) +
  xlab("estimated age") + ylab("total body length (m)") + 
  # Females growth curve
  geom_ribbon(data = growth_F, aes(x = Age_est, ymin = Exp.L.lower, ymax = Exp.L.upper), fill = "lightblue", alpha = 0.4) + 
  geom_line(data = growth_F, aes(x = Age_est, y = Exp.L.mean), color = "lightblue4") +
  # Males growth curve  
  geom_ribbon(data = growth_M, aes(x = Age_est, ymin = Exp.L.lower, ymax = Exp.L.upper), fill = "orange", alpha = 0.4) + 
  geom_line(data = growth_M, aes(x = Age_est, y = Exp.L.mean), color = "darkorange")
```

&nbsp;

Note, you can create custom samplers to use different growth equations (i.e., Gompertz, etc.). See  [Xcertainty](https://github.com/jmhewitt/Xcertainty/tree/main) to learn more. 
